<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutions & Fixes</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }

        .accordion-button::after {
            filter: brightness(0) saturate(100%) invert(32%) sepia(100%) saturate(1200%) hue-rotate(94deg) brightness(95%) contrast(90%);
        }

        pre {
            background-color: #eef3f7;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="text-center mb-4">
        <h2 class="text-success fw-bold">Solutions & Fixes</h2>
        <p class="lead">Congratulations! You've completed all exercises. Below are the solutions and secure coding practices.</p>
    </div>

    <div class="accordion shadow-sm" id="solutionsAccordion">

        <!-- Exercise 1 -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#exercise1" aria-expanded="true" aria-controls="exercise1"></button>
                    Exercise 1 - URL Tampering
                </button>
            </h2>
            <div id="exercise1" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#solutionsAccordion">
                <div class="accordion-body">
                    <div class="accordion" id="subAccordion1">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue1" aria-expanded="false" aria-controls="issue1">Solution</button>
                            </h2>
                            <div id="issue1" class="accordion-collapse collapse" data-bs-parent="#subAccordion1">
                                <div class="accordion-body">
                                    <p>The application allows unauthorised access by URL manipulation. To exploit the vulnerability, you can change /profile/4/ to /profile/5/ in the browser to access the private profile.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fix1" aria-expanded="false" aria-controls="fix1">Fix</button>
                            </h2>
                            <div id="fix1" class="accordion-collapse collapse" data-bs-parent="#subAccordion1">
                                <div class="accordion-body">
                                    <p>To fix the code, ensure that the page is only returned if the user has access - for example, the profile is not private, or if it is, they follow the user. </p>
                                    <h4>Original code</h4>
                                   <pre class="p-3"><code>@login_required
def profile(request, pk):
    profile = get_object_or_404(Profile, pk=pk)
    return render(request, "profile.html", {"profile": profile})</code></pre>
                                    <h4>Fixed code</h4>
                                    <pre class="p-3"><code>@login_required
@login_required
def profile(request, pk):
    profile = get_object_or_404(Profile, pk=pk)

    # If profile is private and the user is not the owner or a follower, deny access
    if profile.private and request.user != profile.user and profile not in request.user.profile.follows.all():
        return HttpResponseForbidden("You do not have access to this profile.")

    return render(request, "profile.html", {"profile": profile})
</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise 2 -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#exercise2" aria-expanded="false" aria-controls="exercise2">
                    Exercise 2 - Cookie Manipulation
                </button>
            </h2>
            <div id="exercise2" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#solutionsAccordion">
                <div class="accordion-body">
                    <div class="accordion" id="subAccordion2">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue2" aria-expanded="false" aria-controls="issue2">Solution</button>
                            </h2>
                            <div id="issue2" class="accordion-collapse collapse" data-bs-parent="#subAccordion2">
                                <div class="accordion-body"></div>
                                    <p>The user role is saved in a client-side cookie that can be edited. It is hashed with 'SHA-256', but the role of 'user' can be reverse engineered.  By hashing the word 'moderator' to 'cfde2ca5188afb7bdd0691c7bef887baba78b709aadde8e8c535329d5751e6fe', you can change your permissions and access the moderator dashboard from your profile.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item"></div>
                            <h2 class="accordion-header"></h2>
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fix2" aria-expanded="false" aria-controls="fix2">Fix</button>
                            </h2>>
                            <div id="fix1" class="accordion-collapse collapse" data-bs-parent="#subAccordion1">
                                <div class="accordion-body">
                                    <p>Instead of storing access roles in a cookie, you can store this securely in the database, without any need for hashing. </p>
                                    <h4>Original code</h4>
                                   <pre class="p-3"><code>@login_required
def home_view(request):
role = request.COOKIES.get("role", "user")  # Role stored in cookie
return render(request, "home.html", {"role": role})</code></pre>
                                    <h4>Fixed code</h4>
                                    <pre class="p-3"><code>@login_required
def home_view(request):
# Determine role securely from the database, not from a cookie
if request.user.is_staff:
    role = "moderator"
else:
    role = "user"
                                        
return render(request, "home.html", {"role": role})</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
